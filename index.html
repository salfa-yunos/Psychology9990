<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cambridge 9990 Psychology Revision App</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a33;
      --panel2:#0f1730;
      --text:#e8eefc;
      --muted:#a9b6d6;
      --accent:#6aa6ff;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --border:rgba(255,255,255,.10);
      --shadow:0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(106,166,255,.15), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 18px 0 18px;
      max-width:1200px;
      margin:0 auto;
    }
    .titlebar{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:6px 0 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      max-width:900px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
      box-shadow: var(--shadow);
    }
    main{
      max-width:1200px;
      margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:14px 14px 0 14px;
      font-size:14px;
      color:var(--muted);
      font-weight:600;
      letter-spacing:.2px;
    }
    .card .body{padding:14px}
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
    }
    select, input[type="text"], textarea{
      width:100%;
      padding:10px 10px;
      background:rgba(0,0,0,.22);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:170px; resize:vertical; line-height:1.4}
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:none;
      padding:10px 12px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      background:rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid var(--border);
    }
    button.primary{
      background: linear-gradient(180deg, rgba(106,166,255,.95), rgba(106,166,255,.65));
      color:#071022;
      border:1px solid rgba(106,166,255,.55);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(239,68,68,.95), rgba(239,68,68,.70));
      color:#190506;
      border:1px solid rgba(239,68,68,.55);
    }
    button.good{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(34,197,94,.70));
      color:#06130a;
      border:1px solid rgba(34,197,94,.55);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }
    .badge{
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
    }
    .qwrap{padding:14px}
    .qhead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .qtitle{
      font-size:16px;
      font-weight:700;
      margin:0;
      line-height:1.35;
    }
    .qstem{
      margin:10px 0 0;
      color:var(--text);
      line-height:1.55;
    }
    .options{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .opt{
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      padding:10px 10px;
      border-radius:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      cursor:pointer;
    }
    .opt input{margin-top:3px}
    .opt:hover{border-color: rgba(106,166,255,.6)}
    .divider{
      height:1px;
      background:var(--border);
      margin:14px 0;
    }
    .feedback{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:rgba(0,0,0,.18);
    }
    .fbTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .result{
      font-weight:800;
      letter-spacing:.2px;
    }
    .result.good{color:var(--good)}
    .result.bad{color:var(--bad)}
    .explain{
      margin:10px 0 0;
      color:var(--muted);
      line-height:1.5;
      font-size:14px;
    }
    .model{
      margin-top:10px;
      padding:10px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:12px;
      background:rgba(255,255,255,.03);
      color:var(--text);
      font-size:13px;
      line-height:1.45;
    }
    .model b{color:var(--accent)}
    .small{font-size:12px;color:var(--muted)}
    .progressbar{
      width:100%;
      height:10px;
      background:rgba(255,255,255,.07);
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--border);
    }
    .progressbar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(106,166,255,.95));
    }
    .mono{font-family:var(--mono)}
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:rgba(0,0,0,.7);
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      color:var(--text);
      box-shadow: var(--shadow);
      display:none;
      z-index:10;
    }
    .kbd{
      font-family:var(--mono);
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .footer{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 18px;
      color:var(--muted);
      font-size:12px;
    }
    .linkish{color:var(--accent); text-decoration:underline; cursor:pointer}
  </style>
</head>
<body>
<header>
  <div class="titlebar">
    <div>
      <h1>üß† Cambridge 9990 Psychology Revision App</h1>
      <p class="subtitle">
        Instant feedback + explanations after every question. Includes a rubric-based ‚ÄúAI marker‚Äù for long answers/essays (Level 1‚Äì4) and a structure aligned to Papers 1‚Äì4 (AS + A Level).
      </p>
    </div>
    <div class="pill">
      <span>Tips:</span>
      <span class="kbd">N</span> Next ‚Ä¢ <span class="kbd">S</span> Submit ‚Ä¢ <span class="kbd">R</span> Random
    </div>
  </div>
</header>

<main>
  <!-- LEFT: Controls / Stats -->
  <section class="card" aria-label="Controls">
    <h2>Setup</h2>
    <div class="body">
      <label for="levelSel">Level</label>
      <select id="levelSel">
        <option value="AS">AS Level (Year 12)</option>
        <option value="A2">A Level (Full / Year 13 content)</option>
      </select>

      <label for="paperSel">Paper</label>
      <select id="paperSel"></select>

      <label for="topicSel">Topic / Option</label>
      <select id="topicSel"></select>

      <div class="row">
        <div>
          <label for="typeSel">Question Type</label>
          <select id="typeSel">
            <option value="mcq">MCQ (1 mark)</option>
            <option value="short">Short Answer (4 marks)</option>
            <option value="application">Application (6 marks)</option>
            <option value="essay">Essay (8‚Äì12 marks)</option>
          </select>
        </div>
        <div>
          <label for="modeSel">Mode</label>
          <select id="modeSel">
            <option value="practice">Practice (show feedback)</option>
            <option value="quiz">Quiz (feedback after submit only)</option>
          </select>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btnStart">Start / Load</button>
        <button id="btnRandom">Random Question</button>
        <button id="btnNext">Next</button>
        <button class="danger" id="btnReset">Reset Progress</button>
      </div>

      <div class="divider"></div>

      <h2 style="padding:0; margin:0 0 10px 0; color:var(--muted); font-size:14px;">Progress</h2>
      <div class="progressbar"><div id="bar"></div></div>
      <div class="meta">
        <div class="badge">Answered: <span id="answered">0</span></div>
        <div class="badge">Correct: <span id="correct">0</span></div>
        <div class="badge">Accuracy: <span id="acc">0%</span></div>
      </div>

      <div class="divider"></div>

      <div class="btns">
        <button id="btnExport">Export Progress</button>
        <button id="btnImport">Import Progress</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>

      <p class="hint">
        ‚úÖ This app enforces your bank structure per topic:
        <b>30 MCQ + 10 Short (4m) + 5 Application (6m) + 5 Essay</b>.
        The Biological Approach set is fully included. Other topics are scaffolded for you to fill.
      </p>

      <p class="hint">
        Essay marking uses a built-in Level 1‚Äì4 rubric (offline). Teacher will update question banks over time.
      </p>
    </div>
  </section>

  <!-- RIGHT: Question Area -->
  <section class="card" aria-label="Question">
    <div class="qwrap">
      <div class="qhead">
        <div>
          <p class="small" id="crumb">‚Äî</p>
          <h3 class="qtitle" id="qTitle">Press ‚ÄúStart / Load‚Äù to begin</h3>
        </div>
        <div class="meta">
          <div class="badge">AO: <span id="ao">‚Äî</span></div>
          <div class="badge">Marks: <span id="marks">‚Äî</span></div>
          <div class="badge mono" id="qid">ID: ‚Äî</div>
        </div>
      </div>

      <p class="qstem" id="qStem">Your question will appear here.</p>

      <div id="answerArea"></div>

      <div class="btns">
        <button class="good" id="btnSubmit" disabled>Submit</button>
        <button id="btnShowModel" disabled>Show Model / Mark Scheme</button>
        <button id="btnAIMark" disabled>AI Mark Essay</button>
      </div>

      <div class="divider"></div>

      <div id="feedbackArea"></div>
    </div>
  </section>
</main>

<div class="footer">
  <p>
    Built for Cambridge 9990 Psychology structure (Papers 1‚Äì4). You can expand the bank by editing the <span class="mono">questionBank</span> in this file.
    If you want, tell me which topic you want next (Cognitive / Learning / Social / Issues & Debates / Research Methods / Clinical etc.) and I‚Äôll generate the full 30+10+5+5 bank for it.
  </p>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================================================
   9990 QUESTION BANK
   - Fully populated: AS Paper 1 > Biological Approach
   - Scaffolded: other topics with placeholder items
   Structure per topic required:
     30 MCQ, 10 Short, 5 Application, 5 Essay
   ========================================================= */

const questionBank = {
  AS: {
    "Paper 1 (Approaches, Issues & Debates)": {
      "Biological Approach": {
        mcq: [
          // 30 MCQs (1 mark) ‚Äî original questions + explanations
          {id:"AS-P1-BIO-M01", ao:["AO1"], marks:1,
            q:"Which structure primarily coordinates movement and balance?",
            options:["Thalamus","Cerebellum","Hippocampus","Medulla oblongata"],
            a:1,
            exp:"The cerebellum coordinates motor control, posture, and balance; damage often causes ataxia and poor coordination."
          },
          {id:"AS-P1-BIO-M02", ao:["AO1"], marks:1,
            q:"Which neurotransmitter is most strongly associated with reward pathways and reinforcement learning?",
            options:["Dopamine","Acetylcholine","GABA","Serotonin"],
            a:0,
            exp:"Dopamine is central to reward prediction and reinforcement; many addictive substances increase dopamine activity."
          },
          {id:"AS-P1-BIO-M03", ao:["AO1"], marks:1,
            q:"A neuron‚Äôs resting potential is mainly maintained by:",
            options:["Sodium-potassium pump","Myelin sheath","Synaptic cleft","Dendrites"],
            a:0,
            exp:"The sodium-potassium pump maintains ionic gradients (Na+ out, K+ in) supporting the resting potential."
          },
          {id:"AS-P1-BIO-M04", ao:["AO1"], marks:1,
            q:"Which part of the brain is commonly linked to forming new episodic memories?",
            options:["Occipital lobe","Hippocampus","Pons","Cerebellum"],
            a:1,
            exp:"The hippocampus helps consolidate new episodic memories; impairment can cause anterograde amnesia."
          },
          {id:"AS-P1-BIO-M05", ao:["AO1"], marks:1,
            q:"Which endocrine gland releases adrenaline during a stress response?",
            options:["Thyroid gland","Pituitary gland","Adrenal glands","Pancreas"],
            a:2,
            exp:"The adrenal glands release adrenaline (epinephrine) in acute stress (fight-or-flight)."
          },
          {id:"AS-P1-BIO-M06", ao:["AO1"], marks:1,
            q:"A synapse is best described as:",
            options:["The insulation on an axon","A junction between neurons where communication occurs","The nucleus of a neuron","A type of glial cell"],
            a:1,
            exp:"Synapses are junctions where neurotransmitters carry signals from one neuron to another."
          },
          {id:"AS-P1-BIO-M07", ao:["AO1"], marks:1,
            q:"Which method most directly separates genetic and environmental influences by comparing similarity across relatives?",
            options:["Natural experiment","Twin study","Case study","Participant observation"],
            a:1,
            exp:"Twin studies compare MZ (identical) and DZ (fraternal) twins to estimate heritability and shared environments."
          },
          {id:"AS-P1-BIO-M08", ao:["AO1"], marks:1,
            q:"The term ‚Äòheritability‚Äô refers to:",
            options:["How a trait is passed from parents to offspring in a single family","The proportion of variation in a trait due to genetic differences within a population","A trait that is caused only by genes","The probability a person will inherit a disease"],
            a:1,
            exp:"Heritability is a population statistic: the proportion of variation explained by genetic differences, not destiny for an individual."
          },
          {id:"AS-P1-BIO-M09", ao:["AO1"], marks:1,
            q:"Which statement best reflects the concept of neuroplasticity?",
            options:["Brain structures cannot change after childhood","Neural connections can strengthen or weaken with experience","Neurons only communicate electrically, not chemically","Brain function is fixed by genetics"],
            a:1,
            exp:"Neuroplasticity refers to the brain‚Äôs capacity to change structure/function based on learning or experience."
          },
          {id:"AS-P1-BIO-M10", ao:["AO1"], marks:1,
            q:"An example of a genotype is:",
            options:["A person‚Äôs height","The allele pair for eye colour","A person‚Äôs accent","A learned habit"],
            a:1,
            exp:"Genotype refers to genetic makeup (alleles). Phenotype refers to observable traits (e.g., height)."
          },
          {id:"AS-P1-BIO-M11", ao:["AO1"], marks:1,
            q:"Which brain imaging method measures blood oxygen level changes (indirect neural activity)?",
            options:["EEG","fMRI","CT scan","PET (always direct)"],
            a:1,
            exp:"fMRI tracks BOLD signals (blood oxygenation), an indirect indicator of neural activity."
          },
          {id:"AS-P1-BIO-M12", ao:["AO1"], marks:1,
            q:"EEG is particularly good for measuring:",
            options:["Precise deep-brain structures","Very fast changes in brain activity over time","Levels of neurotransmitters directly","Exact location of activity with high spatial resolution"],
            a:1,
            exp:"EEG has excellent temporal resolution (milliseconds) but weaker spatial resolution."
          },
          {id:"AS-P1-BIO-M13", ao:["AO1"], marks:1,
            q:"The ‚Äòfight-or-flight‚Äô response is most directly associated with activation of the:",
            options:["Parasympathetic nervous system","Sympathetic nervous system","Somatic nervous system only","Central nervous system only"],
            a:1,
            exp:"The sympathetic branch increases heart rate, respiration, and prepares the body for action in stress."
          },
          {id:"AS-P1-BIO-M14", ao:["AO1"], marks:1,
            q:"Which hormone is commonly associated with long-term stress response via the HPA axis?",
            options:["Insulin","Cortisol","Oxytocin","Melatonin"],
            a:1,
            exp:"Cortisol is a key stress hormone released through the HPA axis, influencing metabolism and immune function."
          },
          {id:"AS-P1-BIO-M15", ao:["AO1"], marks:1,
            q:"A limitation of using correlational evidence in biological psychology is that it:",
            options:["Cannot be replicated","Cannot show cause and effect","Always uses too small samples","Is unethical"],
            a:1,
            exp:"Correlation does not imply causation; biological measures may be linked without one causing the other."
          },
          {id:"AS-P1-BIO-M16", ao:["AO1"], marks:1,
            q:"Reductionism in the biological approach means:",
            options:["Explaining behaviour using simpler biological components","Studying behaviour only in natural settings","Rejecting scientific methods","Focusing only on social influences"],
            a:0,
            exp:"Biological reductionism explains behaviour through physiology (genes, neurotransmitters, brain structures)."
          },
          {id:"AS-P1-BIO-M17", ao:["AO1"], marks:1,
            q:"Which is an example of ‚Äònature‚Äô influence?",
            options:["Peer pressure","Parenting style","Inherited genetic vulnerability","School environment"],
            a:2,
            exp:"Nature refers to innate or genetic factors; nurture refers to environmental influences."
          },
          {id:"AS-P1-BIO-M18", ao:["AO1"], marks:1,
            q:"The main advantage of using MZ twins in research is that they:",
            options:["Share 50% of genes","Share nearly 100% of genes","Always share identical environments","Guarantee high validity"],
            a:1,
            exp:"MZ twins share almost all genes, making them useful for estimating genetic influence when compared to DZ twins."
          },
          {id:"AS-P1-BIO-M19", ao:["AO1"], marks:1,
            q:"Which neurotransmitter is typically inhibitory in the brain?",
            options:["GABA","Dopamine","Glutamate","Noradrenaline"],
            a:0,
            exp:"GABA is a major inhibitory neurotransmitter; glutamate is a major excitatory neurotransmitter."
          },
          {id:"AS-P1-BIO-M20", ao:["AO1"], marks:1,
            q:"The phrase ‚Äòbiological preparedness‚Äô is most closely linked to:",
            options:["Evolutionary explanations of behaviour","Working memory capacity","Social identity theory","Psychodynamic defence mechanisms"],
            a:0,
            exp:"Preparedness suggests some behaviours are more easily learned because they were adaptive in evolution."
          },
          {id:"AS-P1-BIO-M21", ao:["AO1"], marks:1,
            q:"In a typical neuron, information usually travels from:",
            options:["Axon ‚Üí dendrites","Dendrites ‚Üí cell body ‚Üí axon","Cell body ‚Üí dendrites ‚Üí axon","Synapse ‚Üí nucleus ‚Üí dendrites"],
            a:1,
            exp:"Signals are received by dendrites, integrated in the soma, then transmitted along the axon."
          },
          {id:"AS-P1-BIO-M22", ao:["AO1"], marks:1,
            q:"Which brain lobe is most associated with vision processing?",
            options:["Parietal","Temporal","Occipital","Frontal"],
            a:2,
            exp:"The occipital lobe contains the primary visual cortex."
          },
          {id:"AS-P1-BIO-M23", ao:["AO1"], marks:1,
            q:"Which is a strength of using brain imaging in psychology?",
            options:["It always proves causation","It can link biological activity with behaviour in real time or tasks","It removes all ethical issues","It guarantees representative samples"],
            a:1,
            exp:"Imaging can relate patterns of activity to tasks/behaviour, supporting biological explanations (though causation may still be limited)."
          },
          {id:"AS-P1-BIO-M24", ao:["AO1"], marks:1,
            q:"A diathesis-stress view suggests behaviour/disorders result from:",
            options:["Genes only","Environment only","Interaction between vulnerability and stressors","Random chance"],
            a:2,
            exp:"Diathesis-stress models propose a predisposition (genetic/biological) interacts with environmental triggers."
          },
          {id:"AS-P1-BIO-M25", ao:["AO1"], marks:1,
            q:"Which term describes the observable expression of genes influenced by environment?",
            options:["Genotype","Phenotype","Allele","Mutation"],
            a:1,
            exp:"Phenotype is what you can observe (traits/behaviour), shaped by genes and environment."
          },
          {id:"AS-P1-BIO-M26", ao:["AO1"], marks:1,
            q:"A limitation of twin studies is that:",
            options:["They cannot estimate heritability","MZ twins may share more similar environments than DZ twins","They always use invalid measures","They cannot be analysed statistically"],
            a:1,
            exp:"Equal environments assumption may be violated: MZ twins could be treated more similarly, inflating genetic estimates."
          },
          {id:"AS-P1-BIO-M27", ao:["AO1"], marks:1,
            q:"Which statement best describes ‚Äòdeterminism‚Äô in a biological explanation?",
            options:["Behaviour is fully chosen freely","Behaviour is influenced by biological factors beyond conscious control","Behaviour is random","Behaviour is entirely cultural"],
            a:1,
            exp:"Biological explanations often imply determinism: biology influences behaviour outside awareness/choice."
          },
          {id:"AS-P1-BIO-M28", ao:["AO1"], marks:1,
            q:"An agonist drug typically:",
            options:["Blocks a neurotransmitter receptor","Mimics or increases neurotransmitter activity","Removes all neurotransmitters","Stops action potentials in all neurons"],
            a:1,
            exp:"Agonists enhance neurotransmitter effects; antagonists block receptors or reduce activity."
          },
          {id:"AS-P1-BIO-M29", ao:["AO1"], marks:1,
            q:"Which is an example of a gene‚Äìenvironment interaction?",
            options:["Everyone reacts the same way to stress","A genetic vulnerability only shows under high stress environments","Genes have no effect on behaviour","Environment always overrides genes"],
            a:1,
            exp:"Interaction means the effect of genes depends on environment (and vice versa)."
          },
          {id:"AS-P1-BIO-M30", ao:["AO1"], marks:1,
            q:"Which concept best explains why siblings raised together can still differ in personality?",
            options:["Shared environment only","Non-shared environment influences","Genetic cloning","Pure chance only"],
            a:1,
            exp:"Non-shared environments (different peer groups, experiences, roles) contribute to differences even within one family."
          }
        ],
        short: [
          // 10 Short Answer (4 marks)
          {id:"AS-P1-BIO-S01", ao:["AO1"], marks:4,
            q:"Define ‚Äòneurotransmitter‚Äô and explain its role in synaptic transmission. (4 marks)",
            keywords:["chemical messenger","synapse","released","receptors","postsynaptic","signal transmission"],
            model:"A neurotransmitter is a <b>chemical messenger</b> released from a neuron‚Äôs terminal into the <b>synaptic cleft</b>. It binds to <b>receptors</b> on the <b>postsynaptic</b> neuron, changing its membrane potential and helping transmit the <b>signal</b> across the synapse."
          },
          {id:"AS-P1-BIO-S02", ao:["AO1"], marks:4,
            q:"Outline two differences between genotype and phenotype. (4 marks)",
            keywords:["genotype","alleles","genetic makeup","phenotype","observable","environment"],
            model:"<b>Genotype</b> refers to a person‚Äôs <b>genetic makeup</b> (their <b>alleles</b>). <b>Phenotype</b> is the <b>observable</b> trait/behaviour resulting from genotype interacting with the <b>environment</b>."
          },
          {id:"AS-P1-BIO-S03", ao:["AO1"], marks:4,
            q:"Explain one limitation of using fMRI to study behaviour. (4 marks)",
            keywords:["indirect","BOLD","temporal resolution","cost","correlation","cause"],
            model:"fMRI measures brain activity <b>indirectly</b> via the <b>BOLD</b> signal, and often has weaker <b>temporal resolution</b> than EEG. Findings may be <b>correlational</b>, so activity patterns do not necessarily show <b>cause</b> of behaviour."
          },
          {id:"AS-P1-BIO-S04", ao:["AO1"], marks:4,
            q:"Describe what is meant by ‚Äòheritability‚Äô in twin/adoption research. (4 marks)",
            keywords:["population","variation","genetic differences","not individual destiny"],
            model:"Heritability is a <b>population</b> statistic describing the proportion of <b>variation</b> in a trait that is associated with <b>genetic differences</b>. It does <b>not</b> mean a trait is fixed or certain for one individual."
          },
          {id:"AS-P1-BIO-S05", ao:["AO3"], marks:4,
            q:"Explain one strength of the biological approach. (4 marks)",
            keywords:["scientific","objective","measurable","applications","treatments","replicable"],
            model:"A strength is that it often uses <b>scientific</b> methods and <b>objective</b>, <b>measurable</b> data (e.g., imaging, hormones), improving <b>replicability</b>. This also supports practical <b>applications</b> such as drug-based <b>treatments</b>."
          },
          {id:"AS-P1-BIO-S06", ao:["AO1"], marks:4,
            q:"Outline the difference between the sympathetic and parasympathetic nervous systems. (4 marks)",
            keywords:["sympathetic","fight or flight","increase heart rate","parasympathetic","rest and digest","return baseline"],
            model:"The <b>sympathetic</b> system prepares the body for <b>fight-or-flight</b> (e.g., <b>increases heart rate</b>). The <b>parasympathetic</b> system supports <b>rest-and-digest</b>, helping the body <b>return to baseline</b> after stress."
          },
          {id:"AS-P1-BIO-S07", ao:["AO1"], marks:4,
            q:"Explain what is meant by ‚Äòdiathesis-stress‚Äô. (4 marks)",
            keywords:["vulnerability","predisposition","stressors","interaction","trigger"],
            model:"Diathesis-stress proposes a <b>vulnerability</b> or <b>predisposition</b> interacts with environmental <b>stressors</b>. A disorder/behaviour may be <b>triggered</b> when both risk and stress are present."
          },
          {id:"AS-P1-BIO-S08", ao:["AO3"], marks:4,
            q:"Explain one limitation of the biological approach linked to ‚Äòreductionism‚Äô. (4 marks)",
            keywords:["oversimplify","ignore social","ignore cognition","complex behaviour","interaction"],
            model:"A limitation is <b>reductionism</b>: complex behaviour may be <b>oversimplified</b> to biology, potentially <b>ignoring</b> cognitive, social, and cultural influences. Many behaviours result from <b>interactions</b> across levels."
          },
          {id:"AS-P1-BIO-S09", ao:["AO1"], marks:4,
            q:"Describe the role of the hippocampus in memory. (4 marks)",
            keywords:["consolidation","new episodic","long term","spatial","anterograde amnesia"],
            model:"The hippocampus supports <b>consolidation</b> of <b>new episodic</b> information into <b>long-term</b> memory and is also linked to <b>spatial</b> memory. Damage can cause <b>anterograde amnesia</b>."
          },
          {id:"AS-P1-BIO-S10", ao:["AO2","AO3"], marks:4,
            q:"Explain why a correlation between cortisol levels and anxiety does not prove cortisol causes anxiety. (4 marks)",
            keywords:["third variable","bidirectional","correlation not causation","reverse causation","confounding"],
            model:"Correlation does not show causation: anxiety could raise cortisol (<b>reverse causation</b>) or a <b>third variable</b> (e.g., chronic stress, sleep loss) could increase both. Therefore the relationship may be <b>bidirectional</b> or <b>confounded</b>."
          }
        ],
        application: [
          // 5 Application (6 marks)
          {id:"AS-P1-BIO-A01", ao:["AO2"], marks:6,
            q:"A student feels their heart racing before giving a presentation. Using the biological approach, explain what is happening. (6 marks)",
            keywords:["sympathetic","adrenaline","fight or flight","heart rate","stress response","physiological arousal"],
            model:"The situation triggers a stress response; the <b>sympathetic</b> nervous system activates <b>fight-or-flight</b>. The adrenal glands release <b>adrenaline</b>, increasing <b>heart rate</b> and <b>physiological arousal</b> to prepare the body for action."
          },
          {id:"AS-P1-BIO-A02", ao:["AO2"], marks:6,
            q:"A person reports low mood and reduced motivation. Apply a neurotransmitter explanation that could account for this. (6 marks)",
            keywords:["neurotransmitter","serotonin","dopamine","synapse","receptors","mood","motivation"],
            model:"A biological explanation could focus on neurotransmitter imbalance. Reduced <b>serotonin</b> activity can be linked to low mood, while reduced <b>dopamine</b> in reward pathways may lower <b>motivation</b>. At the <b>synapse</b>, fewer neurotransmitters or receptor sensitivity could reduce signalling."
          },
          {id:"AS-P1-BIO-A03", ao:["AO2"], marks:6,
            q:"In a study, MZ twins show more similar fear responses than DZ twins. Apply this to the nature vs nurture debate. (6 marks)",
            keywords:["MZ","DZ","genes","heritability","shared environment","non-shared environment","nature vs nurture"],
            model:"If <b>MZ</b> twins (more genetically similar) are more alike than <b>DZ</b> twins, this suggests a stronger <b>genetic</b> contribution (higher <b>heritability</b>) to fear responses. However, similarity could also be influenced by more similar <b>shared environments</b>, and differences can come from <b>non-shared environments</b>, showing both nature and nurture matter."
          },
          {id:"AS-P1-BIO-A04", ao:["AO2"], marks:6,
            q:"A teenager spends months practising piano and becomes faster at finger movements. Apply neuroplasticity to explain this change. (6 marks)",
            keywords:["practice","synaptic strengthening","neural pathways","myelination","motor cortex","plasticity"],
            model:"Repeated <b>practice</b> strengthens relevant <b>neural pathways</b> (synaptic strengthening) and may increase efficiency via <b>myelination</b>. Changes in motor networks (e.g., <b>motor cortex</b>) reflect <b>neuroplasticity</b>, improving speed and coordination."
          },
          {id:"AS-P1-BIO-A05", ao:["AO2"], marks:6,
            q:"A researcher finds higher stress hormones in students during exam weeks. Apply a biological explanation and one ethical consideration. (6 marks)",
            keywords:["cortisol","HPA axis","stress response","informed consent","harm","confidentiality","debrief"],
            model:"Exam stress activates the <b>HPA axis</b>, increasing <b>cortisol</b> to mobilise energy. Ethically, the study must minimise <b>harm</b> (stress), ensure <b>informed consent</b>, protect <b>confidentiality</b>, and provide <b>debrief</b> or support if anxiety is triggered."
          }
        ],
        essay: [
          // 5 Essays (8‚Äì12 marks). We set max 12 to allow Level 1‚Äì4 marking.
          {id:"AS-P1-BIO-E01", ao:["AO1","AO3"], marks:12,
            q:"Discuss the strengths and limitations of the biological approach to explaining human behaviour. (12 marks)",
            keywordsAO1:["genes","brain","neurotransmitters","hormones","nervous system","evolution"],
            keywordsAO3:["reductionism","determinism","ethical","correlation","cause","methodology","validity","application","treatment","scientific"],
            model:"AO1: Outline biological explanations (genes, brain structures, neurotransmitters/hormones, evolution). AO3: Evaluate using scientific/objective evidence and applications (treatments), but limitations include reductionism, determinism, and issues with correlational evidence/ethics. Conclude with a balanced judgement."
          },
          {id:"AS-P1-BIO-E02", ao:["AO1","AO2","AO3"], marks:12,
            q:"‚ÄòNature and nurture both influence behaviour.‚Äô Discuss this statement using evidence from twin/adoption research. (12 marks)",
            keywordsAO1:["heritability","MZ","DZ","twin studies","adoption studies","genotype","phenotype"],
            keywordsAO3:["equal environments assumption","non-shared environment","interaction","epigenetics","limitations","generalisability"],
            model:"AO1: Explain twin/adoption logic (MZ vs DZ; adoptees vs biological parents). AO2: Apply to behaviour/traits examples. AO3: Evaluate assumptions (equal environments), non-shared environments, gene‚Äìenvironment interaction/epigenetics. Conclude that both contribute."
          },
          {id:"AS-P1-BIO-E03", ao:["AO1","AO3"], marks:12,
            q:"Evaluate the use of brain imaging to investigate psychological processes. (12 marks)",
            keywordsAO1:["fMRI","EEG","PET","BOLD","temporal","spatial"],
            keywordsAO3:["ethics","inference","reverse inference","correlation","cost","ecological validity","reliability"],
            model:"AO1: Describe imaging methods and what they measure. AO3: Strengths include objective biological data; limitations include indirect measures, reverse inference, correlational designs, cost, and ecological validity issues. Balanced conclusion."
          },
          {id:"AS-P1-BIO-E04", ao:["AO1","AO2","AO3"], marks:12,
            q:"Discuss how neurotransmitters and hormones can influence behaviour. Include at least one example for each. (12 marks)",
            keywordsAO1:["dopamine","serotonin","GABA","synapse","receptors","adrenaline","cortisol","oxytocin","endocrine"],
            keywordsAO3:["oversimplify","individual differences","interaction","evidence","ethical","causation"],
            model:"AO1: Explain neurotransmitter transmission and hormonal signalling. AO2: Apply examples (dopamine-reward; serotonin-mood; cortisol-stress; adrenaline-arousal). AO3: Evaluate complexity, individual differences, interactions and causality limits. Conclude."
          },
          {id:"AS-P1-BIO-E05", ao:["AO2","AO3"], marks:12,
            q:"A student says, ‚ÄòI behave this way because my brain made me do it.‚Äô Discuss this statement using issues & debates relevant to the biological approach. (12 marks)",
            keywordsAO1:["determinism","free will","reductionism","holism","individual","situational"],
            keywordsAO3:["balance","interactionist","responsibility","ethical implications","conclusion"],
            model:"Discuss determinism vs free will, reductionism vs holism, and how interactionist views combine biological and environmental factors. Evaluate the implications for responsibility/ethics. Conclude with a balanced judgement."
          }
        ]
      },

      // Scaffolded topics: placeholders (app warns if counts not met)
      "Cognitive Approach": makePlaceholderTopic("AS-P1-COG"),
      "Learning Approach": makePlaceholderTopic("AS-P1-LEA"),
      "Social Approach": makePlaceholderTopic("AS-P1-SOC"),
      "Issues & Debates": makePlaceholderTopic("AS-P1-IAD"),
    },

    "Paper 2 (Research Methods)": {
      "Research Methods Core": makePlaceholderTopic("AS-P2-RM")
    }
  },

  A2: {
    "Paper 3 (Specialist Options: Approaches & Applications)": {
      "Clinical Psychology": makePlaceholderTopic("A2-P3-CLIN"),
      "Health Psychology": makePlaceholderTopic("A2-P3-HEAL"),
      "Consumer Psychology": makePlaceholderTopic("A2-P3-CONS"),
      "Organisational Psychology": makePlaceholderTopic("A2-P3-ORG")
    },
    "Paper 4 (Specialist Options: Research Methods & Issues)": {
      "Specialist Research & Issues": makePlaceholderTopic("A2-P4-SRM")
    }
  }
};

/* ---------- Placeholder generator (so structure exists immediately) ---------- */
function makePlaceholderTopic(prefix){
  const mk = (type, i, marks, ao) => ({
    id:`${prefix}-${type}${String(i).padStart(2,'0')}`,
    ao, marks,
    q:`[PLACEHOLDER] ${prefix} ${type} question ${i}. Replace with your own Cambridge 9990-aligned content.`,
    options: type==="M" ? ["Option A","Option B","Option C","Option D"] : undefined,
    a: type==="M" ? 0 : undefined,
    exp:"Replace this explanation.",
    keywords: ["keyword1","keyword2","keyword3"],
    model:"Replace this model answer / mark scheme.",
    keywordsAO1:["AO1keyword1"], keywordsAO3:["AO3keyword1"]
  });

  // Create minimal placeholders; the app will show warnings for missing counts
  return {
    mcq: Array.from({length:5}, (_,k)=>mk("M",k+1,1,["AO1"])),
    short: Array.from({length:2}, (_,k)=>mk("S",k+1,4,["AO1"])),
    application: Array.from({length:1}, (_,k)=>mk("A",k+1,6,["AO2"])),
    essay: Array.from({length:1}, (_,k)=>mk("E",k+1,12,["AO1","AO3"])),
  };
}

/* =========================================================
   APP STATE + STORAGE
   ========================================================= */
const STORAGE_KEY = "psy9990_progress_v1";

const state = {
  level:"AS",
  paper:"",
  topic:"",
  type:"mcq",
  mode:"practice",
  pool:[],
  idx:0,
  current:null,
  answered:0,
  correct:0,
  // progress by question id:
  progress: {} // { id: {answered:1, correct:1, last:"2026-...", lastAnswer:"..."} }
};

function nowISO(){ return new Date().toISOString(); }

function loadProgress(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(obj && typeof obj === "object"){
      Object.assign(state, obj);
    }
  }catch(e){}
}
function saveProgress(){
  const safe = {
    level:state.level,
    paper:state.paper,
    topic:state.topic,
    type:state.type,
    mode:state.mode,
    idx:state.idx,
    answered:state.answered,
    correct:state.correct,
    progress:state.progress
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(safe));
}

/* =========================================================
   UI HOOKS
   ========================================================= */
const levelSel = document.getElementById("levelSel");
const paperSel = document.getElementById("paperSel");
const topicSel = document.getElementById("topicSel");
const typeSel  = document.getElementById("typeSel");
const modeSel  = document.getElementById("modeSel");

const btnStart = document.getElementById("btnStart");
const btnRandom= document.getElementById("btnRandom");
const btnNext  = document.getElementById("btnNext");
const btnReset = document.getElementById("btnReset");
const btnSubmit= document.getElementById("btnSubmit");
const btnShowModel = document.getElementById("btnShowModel");
const btnAIMark = document.getElementById("btnAIMark");

const crumb = document.getElementById("crumb");
const qTitle= document.getElementById("qTitle");
const qStem = document.getElementById("qStem");
const answerArea = document.getElementById("answerArea");
const feedbackArea = document.getElementById("feedbackArea");
const aoEl = document.getElementById("ao");
const marksEl = document.getElementById("marks");
const qidEl = document.getElementById("qid");

const answeredEl = document.getElementById("answered");
const correctEl = document.getElementById("correct");
const accEl = document.getElementById("acc");
const barEl = document.getElementById("bar");

const toastEl = document.getElementById("toast");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display="block";
  setTimeout(()=> toastEl.style.display="none", 1800);
}

function getPapers(level){
  return Object.keys(questionBank[level] || {});
}
function getTopics(level, paper){
  return Object.keys((questionBank[level]||{})[paper] || {});
}
function getTopicObj(level, paper, topic){
  return ((questionBank[level]||{})[paper]||{})[topic];
}

function populatePapersTopics(){
  // papers
  paperSel.innerHTML = "";
  for(const p of getPapers(state.level)){
    const opt = document.createElement("option");
    opt.value = p; opt.textContent = p;
    paperSel.appendChild(opt);
  }
  state.paper = paperSel.value;

  // topics
  topicSel.innerHTML = "";
  for(const t of getTopics(state.level, state.paper)){
    const opt = document.createElement("option");
    opt.value = t; opt.textContent = t;
    topicSel.appendChild(opt);
  }
  state.topic = topicSel.value;
}

function updateStats(){
  answeredEl.textContent = state.answered;
  correctEl.textContent = state.correct;
  const acc = state.answered ? Math.round((state.correct/state.answered)*100) : 0;
  accEl.textContent = acc + "%";
  const poolCount = state.pool.length || 0;
  const pct = poolCount ? Math.min(100, Math.round((countAnsweredInPool()/poolCount)*100)) : 0;
  barEl.style.width = pct + "%";
}

function countAnsweredInPool(){
  let c=0;
  for(const q of state.pool){
    if(state.progress[q.id]?.answered) c++;
  }
  return c;
}

/* =========================================================
   QUESTION SELECTION + RENDERING
   ========================================================= */
function buildPool(){
  const topicObj = getTopicObj(state.level, state.paper, state.topic);
  if(!topicObj){
    state.pool = [];
    return;
  }

  // Enforce required counts warning
  const required = {mcq:30, short:10, application:5, essay:5};
  const missing = [];
  for(const k of Object.keys(required)){
    const n = (topicObj[k]||[]).length;
    if(n < required[k]) missing.push(`${k.toUpperCase()}: ${n}/${required[k]}`);
  }
  if(missing.length){
    toast(`Bank incomplete for this topic: ${missing.join(" ‚Ä¢ ")}`);
  }

  state.pool = (topicObj[state.type] || []).slice();
  // Sort: unanswered first, then random within
  state.pool.sort((a,b)=>{
    const pa = state.progress[a.id]?.answered ? 1 : 0;
    const pb = state.progress[b.id]?.answered ? 1 : 0;
    if(pa !== pb) return pa - pb;
    return Math.random() - 0.5;
  });
  state.idx = 0;
  state.current = state.pool[0] || null;
}

function renderQuestion(){
  const q = state.current;
  feedbackArea.innerHTML = "";
  btnSubmit.disabled = !q;
  btnShowModel.disabled = !q;
  btnAIMark.disabled = !(q && state.type === "essay");

  if(!q){
    crumb.textContent = "‚Äî";
    qTitle.textContent = "No questions in this selection yet.";
    qStem.textContent = "Try another topic/type, or add questions in the questionBank.";
    answerArea.innerHTML = "";
    aoEl.textContent = "‚Äî";
    marksEl.textContent = "‚Äî";
    qidEl.textContent = "ID: ‚Äî";
    updateStats();
    return;
  }

  crumb.textContent = `${state.level} ‚Üí ${state.paper} ‚Üí ${state.topic} ‚Üí ${labelType(state.type)}`;
  qTitle.textContent = q.q;
  qStem.textContent = "";
  aoEl.textContent = (q.ao||[]).join(", ");
  marksEl.textContent = q.marks ?? "‚Äî";
  qidEl.textContent = `ID: ${q.id}`;

  answerArea.innerHTML = "";

  if(state.type === "mcq"){
    const wrap = document.createElement("div");
    wrap.className="options";
    q.options.forEach((text, i)=>{
      const lab = document.createElement("label");
      lab.className="opt";
      lab.innerHTML = `<input type="radio" name="mcq" value="${i}" /> <div><b>${String.fromCharCode(65+i)}.</b> ${escapeHtml(text)}</div>`;
      wrap.appendChild(lab);
    });
    answerArea.appendChild(wrap);
  } else if(state.type === "short" || state.type === "application"){
    answerArea.innerHTML = `
      <label>Your answer (use key terms):</label>
      <input type="text" id="shortAns" placeholder="Type your answer here..." />
      <p class="hint">Auto-marking uses keyword matching. You will see which key terms you included/missed.</p>
    `;
  } else if(state.type === "essay"){
    answerArea.innerHTML = `
      <label>Your essay answer (aim for PEEL + evaluation + conclusion):</label>
      <textarea id="essayAns" placeholder="Write your essay here..."></textarea>
      <div class="meta">
        <div class="badge">Word count: <span id="wc">0</span></div>
        <div class="badge">Target: balanced AO1 + AO3 + conclusion</div>
      </div>
      <p class="hint">
        Use: <b>AO1</b> (accurate knowledge), <b>AO2</b> (apply if scenario), <b>AO3</b> (evaluate: strengths/limitations, counter-arguments).
        End with a <b>clear conclusion</b>.
      </p>
    `;
    const ta = answerArea.querySelector("#essayAns");
    const wc = answerArea.querySelector("#wc");
    ta.addEventListener("input", ()=>{
      wc.textContent = countWords(ta.value);
    });
  }

  updateStats();
}

function labelType(t){
  return ({mcq:"MCQ", short:"Short (4m)", application:"Application (6m)", essay:"Essay"})[t] || t;
}

function nextQuestion(){
  if(!state.pool.length) return;
  state.idx = (state.idx + 1) % state.pool.length;
  state.current = state.pool[state.idx];
  renderQuestion();
}

function randomQuestion(){
  if(!state.pool.length) return;
  state.idx = Math.floor(Math.random()*state.pool.length);
  state.current = state.pool[state.idx];
  renderQuestion();
}

/* =========================================================
   MARKING & FEEDBACK
   ========================================================= */

function submitAnswer(){
  const q = state.current;
  if(!q) return;

  let isCorrect = false;
  let userAnswer = "";
  let autoScore = null;
  let notes = "";

  if(state.type === "mcq"){
    const picked = document.querySelector('input[name="mcq"]:checked');
    if(!picked){ toast("Choose an option first."); return; }
    userAnswer = Number(picked.value);
    isCorrect = (userAnswer === q.a);
    notes = `Correct answer: <b>${String.fromCharCode(65+q.a)}</b> ‚Äî ${escapeHtml(q.options[q.a])}`;
  }

  if(state.type === "short" || state.type === "application"){
    const inp = document.getElementById("shortAns");
    if(!inp || !inp.value.trim()){ toast("Write an answer first."); return; }
    userAnswer = inp.value.trim();

    const kw = (q.keywords || []).map(k=>k.toLowerCase());
    const txt = userAnswer.toLowerCase();

    const hits = kw.filter(k=> txt.includes(k));
    const miss = kw.filter(k=> !txt.includes(k));

    // Simple mark: proportion of keywords hit -> marks
    autoScore = Math.max(0, Math.min(q.marks, Math.round((hits.length / Math.max(kw.length,1))*q.marks)));
    isCorrect = autoScore >= Math.ceil(q.marks*0.75); // treat "mostly correct" as correct for stats

    notes = `
      <div class="small">Keyword hits: <b style="color:var(--good)">${hits.join(", ") || "none"}</b></div>
      <div class="small">Missing: <b style="color:var(--warn)">${miss.join(", ") || "none"}</b></div>
      <div class="small">Auto-score: <b>${autoScore}/${q.marks}</b> (You can compare to model answer below.)</div>
    `;
  }

  if(state.type === "essay"){
    const ta = document.getElementById("essayAns");
    if(!ta || !ta.value.trim()){ toast("Write your essay first."); return; }
    userAnswer = ta.value.trim();

    // In quiz mode, we still show feedback after submit (your requirement).
    const ai = markEssaySimulated(q, userAnswer);
    autoScore = ai.marks;
    isCorrect = autoScore >= Math.ceil(q.marks*0.70);
    notes = essayNotes(ai);
  }

  // update progress
  if(!state.progress[q.id]?.answered) state.answered++;
  const prevCorrect = state.progress[q.id]?.correct ? 1 : 0;
  const newCorrect = isCorrect ? 1 : 0;
  if(prevCorrect !== newCorrect){
    state.correct += (newCorrect - prevCorrect);
  }

  state.progress[q.id] = {
    answered: 1,
    correct: newCorrect,
    last: nowISO(),
    lastAnswer: typeof userAnswer === "number" ? String(userAnswer) : userAnswer.slice(0, 2000)
  };

  saveProgress();
  updateStats();
  showFeedback(q, isCorrect, notes, autoScore);
}

function showFeedback(q, isCorrect, notesHtml, autoScore){
  const mode = state.mode;
  const resTxt = isCorrect ? "‚úÖ Correct" : "‚ùå Not quite";
  const resClass = isCorrect ? "good" : "bad";

  // Always show explanation after every question (your requirement)
  const explanation = q.exp ? `<div class="explain"><b>Explanation:</b> ${escapeHtml(q.exp)}</div>` : "";
  const scoreLine = (autoScore !== null && autoScore !== undefined) ? `<div class="badge">Score: <b>${autoScore}/${q.marks}</b></div>` : "";

  feedbackArea.innerHTML = `
    <div class="feedback">
      <div class="fbTop">
        <div class="result ${resClass}">${resTxt}</div>
        <div class="meta">
          ${scoreLine}
          <div class="badge">AO: ${(q.ao||[]).join(", ")}</div>
        </div>
      </div>
      <div class="model">${notesHtml || ""}</div>
      ${explanation}
    </div>
  `;
}

function showModel(){
  const q = state.current;
  if(!q) return;

  let html = "";
  if(state.type === "mcq"){
    html = `
      <div class="model">
        <b>Correct:</b> ${String.fromCharCode(65+q.a)} ‚Äî ${escapeHtml(q.options[q.a])}<br/>
        <b>Explanation:</b> ${escapeHtml(q.exp || "‚Äî")}
      </div>
    `;
  } else {
    html = `
      <div class="model">
        <b>Model / Mark Scheme:</b><br/>
        ${q.model || "<i>No model answer provided yet.</i>"}
        <div class="small" style="margin-top:8px;">
          Key terms expected: <span class="mono">${(q.keywords||[]).join(", ")}</span>
        </div>
      </div>
    `;
  }

  feedbackArea.innerHTML = html + feedbackArea.innerHTML;
  toast("Model answer shown.");
}

/* =========================================================
   ESSAY ‚ÄúAI MARKER‚Äù (SIMULATED)
   - Level 1: Basic description
   - Level 2: Some application / limited evaluation
   - Level 3: Clear evaluation + organisation
   - Level 4: Balanced argument + conclusion
   ========================================================= */

function markEssaySimulated(q, text){
  const words = countWords(text);
  const lower = text.toLowerCase();

  const ao1 = (q.keywordsAO1 || q.keywords || []).map(s=>s.toLowerCase());
  const ao3 = (q.keywordsAO3 || []).map(s=>s.toLowerCase());

  const ao1Hits = ao1.filter(k=> lower.includes(k));
  const ao3Hits = ao3.filter(k=> lower.includes(k));

  const evalMarkers = ["however","on the other hand","a limitation","a strength","this suggests","therefore","validity","reliability","generalisability","ethical","reductionist","determinism","counter-argument","but"];
  const hasEvalLanguage = evalMarkers.some(m=> lower.includes(m));

  const hasConclusion = /in conclusion|to conclude|overall|to sum up|therefore/i.test(text);
  const hasBalance = (lower.includes("however") || lower.includes("on the other hand")) && (lower.includes("strength") || lower.includes("advantage")) && (lower.includes("limitation") || lower.includes("disadvantage"));

  // rough AO coverage scores (0-1)
  const ao1Score = ao1.length ? (ao1Hits.length / ao1.length) : 0.3;
  const ao3Score = ao3.length ? (ao3Hits.length / ao3.length) : (hasEvalLanguage ? 0.4 : 0.1);

  // Determine level
  let level = 1;

  // Level 2: some relevant knowledge + some structure; maybe minimal evaluation OR application cues
  if(words >= 80 && ao1Hits.length >= 2) level = 2;

  // Level 3: clear evaluation + multiple evaluative points
  if(words >= 140 && ao1Hits.length >= 3 && (hasEvalLanguage || ao3Hits.length >= 2)) level = 3;

  // Level 4: balanced + conclusion + strong AO3
  if(words >= 180 && ao1Hits.length >= 4 && (hasBalance || ao3Hits.length >= 3) && hasConclusion) level = 4;

  // Map level to mark band (out of q.marks)
  const max = q.marks || 12;
  const band = {
    1: [Math.floor(max*0.25), Math.floor(max*0.40)],
    2: [Math.floor(max*0.41), Math.floor(max*0.60)],
    3: [Math.floor(max*0.61), Math.floor(max*0.80)],
    4: [Math.floor(max*0.81), max]
  }[level];

  // score within band based on AO1+AO3 coverage
  const blend = Math.min(1, (ao1Score*0.55 + ao3Score*0.45));
  const marks = clamp(Math.round(band[0] + (band[1]-band[0]) * blend), 0, max);

  // feedback suggestions
  const missingAO1 = ao1.filter(k=> !lower.includes(k)).slice(0,6);
  const missingAO3 = ao3.filter(k=> !lower.includes(k)).slice(0,6);

  const improve = [];
  if(ao1Hits.length < 3) improve.push("Add more accurate AO1 knowledge (key terms, concepts, named processes).");
  if(!hasEvalLanguage) improve.push("Add AO3 evaluation language (strengths/limitations, reliability/validity, assumptions).");
  if(!hasConclusion) improve.push("Finish with a clear conclusion that weighs both sides.");
  if(!hasBalance) improve.push("Include BOTH a strength and a limitation (balanced argument).");
  if(words < 140) improve.push("Develop your points further (PEEL: Point‚ÄìEvidence‚ÄìExplain‚ÄìLink).");

  return {
    level,
    marks,
    max,
    words,
    ao1Hits,
    ao3Hits,
    missingAO1,
    missingAO3,
    improve
  };
}

function essayNotes(ai){
  const lvlText = ["","Level 1 (basic description)","Level 2 (some application)","Level 3 (clear evaluation)","Level 4 (balanced + conclusion)"][ai.level];
  return `
    <div><b>Simulated AI Marker:</b> <span style="color:var(--accent)">${lvlText}</span></div>
    <div class="small">Word count: <b>${ai.words}</b> ‚Ä¢ Estimated mark: <b>${ai.marks}/${ai.max}</b></div>
    <div class="small" style="margin-top:8px;">
      AO1 hits: <span style="color:var(--good)">${ai.ao1Hits.join(", ") || "none"}</span><br/>
      AO3 hits: <span style="color:var(--good)">${ai.ao3Hits.join(", ") || "none"}</span>
    </div>
    <div class="small" style="margin-top:8px;">
      Missing AO1 (sample): <span style="color:var(--warn)">${ai.missingAO1.join(", ") || "none"}</span><br/>
      Missing AO3 (sample): <span style="color:var(--warn)">${ai.missingAO3.join(", ") || "none"}</span>
    </div>
    <div class="small" style="margin-top:8px;">
      <b>How to improve:</b>
      <ul style="margin:6px 0 0 18px; color:var(--muted)">
        ${(ai.improve.length ? ai.improve : ["Keep this structure; add more depth and precise terms for full marks."]).map(s=>`<li>${escapeHtml(s)}</li>`).join("")}
      </ul>
    </div>
  `;
}

function aiMarkEssay(){
  const q = state.current;
  if(!q || state.type !== "essay") return;
  const ta = document.getElementById("essayAns");
  if(!ta || !ta.value.trim()){ toast("Write your essay first."); return; }
  const ai = markEssaySimulated(q, ta.value.trim());
  showFeedback(q, ai.marks >= Math.ceil(q.marks*0.70), essayNotes(ai), ai.marks);
}

/* =========================================================
   EXPORT / IMPORT
   ========================================================= */
document.getElementById("btnExport").addEventListener("click", ()=>{
  const data = {
    exportedAt: nowISO(),
    app: "psy9990_revision_app",
    version: 1,
    state: {
      answered: state.answered,
      correct: state.correct,
      progress: state.progress
    }
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "psy9990_progress.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById("btnImport").addEventListener("click", ()=>{
  document.getElementById("importFile").click();
});

document.getElementById("importFile").addEventListener("change", (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(obj?.state?.progress){
        state.progress = obj.state.progress;
        state.answered = obj.state.answered ?? state.answered;
        state.correct = obj.state.correct ?? state.correct;
        saveProgress();
        updateStats();
        toast("Progress imported.");
      } else {
        toast("Invalid file format.");
      }
    }catch(err){
      toast("Could not import file.");
    }
  };
  reader.readAsText(file);
});

/* =========================================================
   HELPERS
   ========================================================= */
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function countWords(text){
  return (text.trim().match(/\b\w+\b/g) || []).length;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* =========================================================
   WIRING EVENTS
   ========================================================= */
levelSel.addEventListener("change", ()=>{
  state.level = levelSel.value;
  populatePapersTopics();
  state.paper = paperSel.value;
  state.topic = topicSel.value;
  saveProgress();
});

paperSel.addEventListener("change", ()=>{
  state.paper = paperSel.value;
  topicSel.innerHTML = "";
  for(const t of getTopics(state.level, state.paper)){
    const opt = document.createElement("option");
    opt.value = t; opt.textContent = t;
    topicSel.appendChild(opt);
  }
  state.topic = topicSel.value;
  saveProgress();
});

topicSel.addEventListener("change", ()=>{
  state.topic = topicSel.value;
  saveProgress();
});

typeSel.addEventListener("change", ()=>{
  state.type = typeSel.value;
  saveProgress();
});
modeSel.addEventListener("change", ()=>{
  state.mode = modeSel.value;
  saveProgress();
});

btnStart.addEventListener("click", ()=>{
  state.level = levelSel.value;
  state.paper = paperSel.value;
  state.topic = topicSel.value;
  state.type = typeSel.value;
  state.mode = modeSel.value;

  buildPool();
  renderQuestion();
  saveProgress();
  toast("Loaded.");
});

btnNext.addEventListener("click", ()=>{
  nextQuestion();
  saveProgress();
});
btnRandom.addEventListener("click", ()=>{
  randomQuestion();
  saveProgress();
});
btnSubmit.addEventListener("click", submitAnswer);
btnShowModel.addEventListener("click", showModel);
btnAIMark.addEventListener("click", aiMarkEssay);

btnReset.addEventListener("click", ()=>{
  if(!confirm("Reset ALL saved progress?")) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
});

// keyboard shortcuts
document.addEventListener("keydown", (e)=>{
  if(e.key.toLowerCase()==="n"){ nextQuestion(); }
  if(e.key.toLowerCase()==="r"){ randomQuestion(); }
  if(e.key.toLowerCase()==="s"){ submitAnswer(); }
});

/* =========================================================
   INITIAL LOAD
   ========================================================= */
(function init(){
  loadProgress();

  levelSel.value = state.level || "AS";
  state.level = levelSel.value;

  populatePapersTopics();

  // restore selections if available
  if(state.paper && getPapers(state.level).includes(state.paper)){
    paperSel.value = state.paper;
  } else {
    state.paper = paperSel.value;
  }

  // refresh topics for paper
  topicSel.innerHTML = "";
  for(const t of getTopics(state.level, state.paper)){
    const opt = document.createElement("option");
    opt.value = t; opt.textContent = t;
    topicSel.appendChild(opt);
  }

  if(state.topic && getTopics(state.level, state.paper).includes(state.topic)){
    topicSel.value = state.topic;
  } else {
    state.topic = topicSel.value;
  }

  typeSel.value = state.type || "mcq";
  modeSel.value = state.mode || "practice";

  // Auto-load last session
  buildPool();
  renderQuestion();
  updateStats();
})();

/* =========================================================
   OPTIONAL: REAL AI MARKER (PLUG-IN GUIDE)
   =========================================================
   If you want true AI marking (beyond keyword heuristics), you can:
   - Host an endpoint (Azure Function / Power Automate / Copilot Studio action)
   - Send: {questionId, questionText, maxMarks, rubricLevels, studentAnswer}
   - Return: {level, marks, strengths[], improvements[], annotatedFeedback}

   Example (pseudo):
   async function markEssayWithAPI(payload){
     const res = await fetch("YOUR_ENDPOINT", {
       method:"POST",
       headers:{ "Content-Type":"application/json", "Authorization":"Bearer ..."},
       body: JSON.stringify(payload)
     });
     return await res.json();
   }
========================================================= */
</script>
</body>
</html>